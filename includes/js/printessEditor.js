class PrintessEditor{constructor(e){if(this.calculateCurrentPrices=(e,t)=>{var i=this.getPriceCategories(t);let n=t.getPriceForFormFields(t.getCurrentFormFieldValues());return e.snippetPriceCategories&&e.snippetPriceCategories.forEach(e=>{e&&0<e.amount&&t.snippetPrices[e.priceCategory-1]&&(n+=t.snippetPrices[e.priceCategory-1].priceInCent)}),i.price=t.formatMoney(n),i},!e||!e.shopToken)throw"No shop token provided";this.Settings={...e};e={};null!=this.Settings.uiSettings&&(e.showAnimation=!0===this.Settings.uiSettings.showStartupAnimation||"true"==this.Settings.uiSettings.showStartupAnimation,this.Settings.uiSettings.startupLogoUrl&&(e.imageUrl=this.Settings.uiSettings.startupLogoUrl),this.Settings.uiSettings.startupBackgroundColor)&&(e.background=this.Settings.uiSettings.startupBackgroundColor),this.ClassicEditorUrl=this.getClassicEditorUrl(this.Settings.editorUrl,this.Settings.editorVersion,e)+"#"+encodeURIComponent(JSON.stringify(e))}stripEditorVersion(e){if(void 0!==(e=(e||"").trim())&&null!=e)if(e){for(;0==e.indexOf("/");)e=e.substring(1);for(;0<e.length&&"/"===e[e.length-1];)e=e.substring(0,e.length-1)}else e="";return e}sanitizeHost(e){return e?(e=e.trim()).endsWith("/")?e:e+"/":e||""}getClassicEditorUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var s=e.substring(n+1);if(s)try{var r=JSON.parse(decodeURIComponent(s));if(r)for(var o in r)r.hasOwnProperty(o)&&(i[o]=r[o])}catch(e){}e=e.substring(0,n)}return e.toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e+="printess-editor/embed.html"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getLoaderUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var s=e.substring(n+1);if(s)try{var r=JSON.parse(decodeURIComponent(s));if(r)for(var o in r)r.hasOwnProperty(o)&&(i[o]=r[o])}catch(e){}e=e.substring(0,n)}return(e=e.toLocaleLowerCase().endsWith("embed.html")?e.substring(0,e.length-"embed.html".length):e).toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e.toLowerCase().endsWith("printess-editor/")||(e+="printess-editor/"),e+="loader.js"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getPrintessComponent(){return document.querySelector("printess-component")||null}applyFormFieldMappings(t,i){var n=[];if(!i)for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,value:t[e]});if(t)for(var s in t)if(t.hasOwnProperty(s)){var r=t[s],o=void 0!==i[s]&&void 0!==i[s].formField?i[s].formField:s;let e=r;void 0!==i[s]&&void 0!==i[s].values&&void 0!==i[s].values[e]&&(e=i[s].values[r]),n.push({name:o,value:e})}return n}reverseFormFieldMapping(e,t,i){let n=e||"",s=t||"";if(i)for(var r in i)if(i.hasOwnProperty(r)&&i[r].formField===e){if(i[n=r].values)for(var o in i[r].values)if(i[r].values.hasOwnProperty(o)&&i[r].values[o]===t){s=o;break}break}return{name:n,value:s}}setViewportMeta(){var i=document.getElementsByTagName("head");if(i&&0<i.length){let e=i[0].querySelector("meta[name=viewport]"),t=(e||((e=document.createElement("meta")).setAttribute("name","viewport"),i[0].appendChild(e)),e.getAttribute("content"));t?t.indexOf("interactive-widget")<0&&(t=t+(t?", ":"")+"interactive-widget=resizes-content",e.setAttribute("content",t)):e.setAttribute("content","interactive-widget=resizes-content")}}async initializeIFrame(t,e,i){let n=this,s=document.getElementById("printess"),r=e=>{t&&"function"==typeof t.onCloseTab&&t.onCloseTab(e)},o=e=>{switch(e.data.cmd){case"back":window.removeEventListener("message",o),window.removeEventListener("beforeunload",r),window.removeEventListener("unload",r),s.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onBack&&t.onBack();break;case"basket":window.removeEventListener("message",o),window.removeEventListener("beforeunload",r),window.removeEventListener("unload",r),s.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onAddToBasket&&t.onAddToBasket(e.data.token,e.data.thumbnailUrl);break;case"formFieldChanged":t&&"function"==typeof t.onFormFieldChanged&&t.onFormFieldChanged(e.data.n||e.data.name,e.data.v||e.data.value,e.data.ffCaption||"",e.data.l||e.data.label);break;case"priceChanged":t&&"function"==typeof t.onPriceChanged&&t.onPriceChanged(e.data.priceInfo);break;case"renderFirstPageImage":t&&"function"==typeof t.onRenderedFirstPageImage&&t.onRenderedFirstPageImage(e.data.result);break;case"save":t&&"function"==typeof t.onSave&&t.onSave(e.data.token)}};return new Promise(e=>{var t;s?("true"!==s.getAttribute("printessHasListener")&&(window.addEventListener("message",o),!0===i.showAlertOnTabClose&&(window.addEventListener("beforeunload",r),window.addEventListener("unload",r)),s.setAttribute("printessHasListener","true")),e(s)):((t=document.createElement("div")).setAttribute("id","printess-container"),t.setAttribute("style","display: none; position: absolute; top: 0; bottom: 0; right: 0; left: 0; width: 100%; height: 100%; z-index: 100000;"),(s=document.createElement("iframe")).setAttribute("src",this.ClassicEditorUrl),s.setAttribute("id","printess"),s.setAttribute("style","width:100%; heigth:100%;"),s.setAttribute("data-attached","false"),s.setAttribute("allow","xr-spatial-tracking; clipboard-read; clipboard-write;"),s.setAttribute("allowfullscreen","true"),s.classList.add("printess-owned"),t.appendChild(s),s.onload=()=>{e(s)},window.addEventListener("message",o),!0===i.showAlertOnTabClose&&(window.addEventListener("beforeunload",r),window.addEventListener("unload",r)),s.setAttribute("printessHasListener","true"),window.visualViewport&&window.visualViewport.addEventListener("scroll",()=>{s.contentWindow?.postMessage({cmd:"viewportScroll",height:window.visualViewport?.height,offsetTop:window.visualViewport?.offsetTop},"*")},{passive:!0}),n.setViewportMeta(),document.body.append(t))})}getPriceCategories(e){return{snippetPrices:e.snippetPrices.map(e=>e?e.label:null),priceCategories:{},price:e.formatMoney(e.getPriceForFormFields(e.getCurrentFormFieldValues())),productName:e.getProductName(),legalNotice:e.legalText,infoUrl:e.legalTextUrl}}onPriceChanged(i,n){try{let e=document.getElementById("printess"),t=null;try{i.snippetPriceCategories&&0<i.snippetPriceCategories.length?n.stickers=i.snippetPriceCategories.filter(e=>n.snippetPrices&&n.snippetPrices.length>=e.priceCategory).map(e=>({productVariantId:n.snippetPrices[e.priceCategory-1].variantId,quantity:e.amount})):n.stickers=[],t=this.calculateCurrentPrices(i,n)}catch(e){console.error(e)}e&&!n.hidePricesInEditor&&setTimeout(()=>{e.contentWindow.postMessage({cmd:"refreshPriceDisplay",priceDisplay:t},"*")},0)}catch(e){}}hideBcUiVersion(e,t){var i=this.getPrintessComponent();i&&i.editor&&i.editor.ui.hide(),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}async showBcUiVersion(t,r){let i=this;var e=t.getPriceInfo();let n=null,s=null;n=i.applyFormFieldMappings(t.getCurrentFormFieldValues(),t.getFormFieldMappings()),s=t.getMergeTemplates();var o=i.getLoaderUrl(this.Settings.editorUrl,this.Settings.editorVersion,{}),o=await import(o);let a=i.getPrintessComponent();a&&a.editor?(a.style.display="block",await a.editor.api.loadTemplateAndFormFields(t.templateNameOrSaveToken,s,n,null),a.editor.ui.show()):(e={domain:i.Settings.apiDomain,mergeTemplates:s,formFields:n,token:i.Settings.shopToken,templateName:t.templateNameOrSaveToken,translationKey:"",basketId:"function"==typeof t.getBasketId&&t.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof t.getUserId?t.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",snippetPriceCategoryLabels:e&&e.snippetPrices?e.snippetPrices:null,theme:i.Settings.uiSettings&&i.Settings.uiSettings.theme||"",addToBasketCallback:(e,t)=>{r&&"function"==typeof r.onAddToBasket&&r.onAddToBasket(e,t)},formFieldChangedCallback:(e,t,i,n,s)=>{r&&"function"==typeof r.onFormFieldChanged&&r.onFormFieldChanged(e,t,s,n)},priceChangeCallback:e=>{r&&"function"==typeof r.onPriceChanged&&r.onPriceChanged(e)},backButtonCallback:e=>{i.hideBcUiVersion(t,!0)},saveTemplateCallback:(e,t)=>{"function"==typeof r.onSave&&r.onSave(e)}},o=await o.load(e),(a=i.getPrintessComponent())&&(a.editor=o))}async show(s){let r=this,n=!1;s&&s.templateNameOrSaveToken&&(n=0===s.templateNameOrSaveToken.indexOf("st:")&&90===s.templateNameOrSaveToken.length);var o={onBack:()=>{r.hide(s,!0)},onAddToBasket:(e,t)=>{let i=s.onAddToBasket(e,t);i&&i.waitUntilClosingMS?setTimeout(function(){"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),r.hide(s,!1)},i.waitUntilClosingMS):(i&&"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),r.hide(s,!1))},onFormFieldChanged:(e,t,i,n)=>{e=r.reverseFormFieldMapping(e,t,s.getFormFieldMappings());"function"==typeof s.onFormFieldChanged&&s.onFormFieldChanged(e.name,e.value,i,n)},onPriceChanged:e=>{r.onPriceChanged(e,s)},onRenderedFirstPageImage:e=>{"function"==typeof s.onRenderFirstPageImage&&s.onRenderFirstPageImage(e)},onSave:e=>{"function"==typeof s.onSave&&s.onSave(e,"")},onCloseTab:e=>{e.preventDefault(),e.returnValue=""}};if(this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion)r.showBcUiVersion(s,o);else{var a=s.getPriceInfo();let e=null,t=null,i=(n||(e=this.applyFormFieldMappings(s.getCurrentFormFieldValues(),s.getFormFieldMappings()),t=s.getMergeTemplates()),await this.initializeIFrame(o,s,this.Settings));if("false"===i.getAttribute("data-attached"))try{var d={domain:r.Settings.apiDomain,token:this.Settings.shopToken||"",templateName:s.templateNameOrSaveToken,showBuyerSide:!0,templateUserId:"",basketId:"function"==typeof s.getBasketId&&s.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof s.getUserId?s.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",formFields:e,snippetPriceCategoryLabels:a&&a.snippetPrices?a.snippetPrices:null,mergeTemplates:t};if(null!=s.showSplitterGridSizeButton&&(d.showSplitterGridSizeButton=!0===s.showSplitterGridSizeButton||"true"===s.showSplitterGridSizeButton),this.Settings.uiSettings&&this.Settings.uiSettings.theme&&(d.theme=this.Settings.uiSettings.theme),this.Settings.attachParams)for(var l in this.Settings.attachParams)this.Settings.attachParams.hasOwnProperty(l)&&(d[l]=this.Settings.attachParams[l]);if(void 0!==s.additionalAttachParams||null!==s.additionalAttachParams)for(var p in s.additionalAttachParams)s.additionalAttachParams.hasOwnProperty(p)&&(d[p]=s.additionalAttachParams[p]);i.contentWindow.postMessage({cmd:"attach",properties:d},"*"),i.setAttribute("data-attached","true"),setTimeout(function(){i.contentWindow.focus()},0)}catch(e){console.error(e)}else{o={templateNameOrToken:s.templateNameOrSaveToken,mergeTemplates:t,formFields:e,snippetPriceCategoryLabels:a&&a.snippetPrices?a.snippetPrices:null,formFieldProperties:void 0,clearExchangeCaches:!0};this.Settings.attachParams&&(this.Settings.attachParams.formFieldProperties&&(o.formFieldProperties=this.Settings.attachParams.formFieldProperties),void 0!==this.Settings.attachParams.clearExchangeCaches)&&(o.clearExchangeCaches=!1!==this.Settings.attachParams.clearExchangeCaches),s&&s.additionalAttachParams&&(s.additionalAttachParams.formFieldProperties&&(o.formFieldProperties=s.additionalAttachParams.formFieldProperties),void 0!==s.additionalAttachParams.clearExchangeCaches)&&(o.clearExchangeCaches=!1!==s.additionalAttachParams.clearExchangeCaches),i.contentWindow.postMessage({cmd:"loadTemplateAndFormFields",parameters:[o.templateNameOrToken,o.mergeTemplates,o.formFields,o.snippetPriceCategoryLabels,o.formFieldProperties,o.clearExchangeCaches]},"*"),setTimeout(function(){i.contentWindow.focus()},0)}}document.body.classList.add("hideAll");a=document.getElementsByTagName("html"),a&&0<a.length&&a[0].classList.add("printess-editor-open"),o=document.getElementById("printess-container");o&&o.style.setProperty("display","block","important")}hide(e,t){this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion?(i=this.getPrintessComponent())&&i.editor&&i.editor.ui.hide():(i=document.getElementById("printess-container"))&&(i.style.display="none"),document.body.classList.remove("hideAll");var i=document.getElementsByTagName("html");i&&0<i.length&&i[0].classList.remove("printess-editor-open"),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}}function initPrintessEditor(e,t,i,n,s,r,o=""){let a;return a=e&&"string"!=typeof e?{apiDomain:e.apiDomain||null,shopToken:e.shopToken||"",editorUrl:e.editorUrl||"",editorVersion:e.editorVersion||"",attachParams:e.attachParams||"",showAlertOnTabClose:null!=e.showTabClosingAlert&&!0===e.showTabClosingAlert,uiSettings:{showStartupAnimation:null==e.showStartupAnimation||!0===e.showStartupAnimation,startupBackgroundColor:e.startupBackgroundColor||"#ffffff",theme:e.theme||"",startupLogoUrl:e.startupLogoUrl||"",uiVersion:e.uiVersion||""},...e}:{apiDomain:null,shopToken:e||"",editorUrl:t,editorVersion:i,uiSettings:{showStartupAnimation:s,startupBackgroundColor:o,startupLogoUrl:n,theme:r}},new PrintessEditor(a)};