class PrintessEditor{constructor(e){if(this.calculateCurrentPrices=(e,t)=>{var i=this.getPriceCategories(t);let n=t.getPriceForFormFields(t.getCurrentFormFieldValues());return e.snippetPriceCategories&&e.snippetPriceCategories.forEach(e=>{e&&0<e.amount&&t.snippetPrices[e.priceCategory-1]&&(n+=t.snippetPrices[e.priceCategory-1].priceInCent)}),i.price=t.formatMoney(n),i},!e||!e.shopToken)throw"No shop token provided";this.Settings={...e};e={};null!=this.Settings.uiSettings&&(e.showAnimation=!0===this.Settings.uiSettings.showStartupAnimation||"true"==this.Settings.uiSettings.showStartupAnimation,this.Settings.uiSettings.startupLogoUrl&&(e.imageUrl=this.Settings.uiSettings.startupLogoUrl),this.Settings.uiSettings.startupBackgroundColor)&&(e.background=this.Settings.uiSettings.startupBackgroundColor),this.ClassicEditorUrl=this.getClassicEditorUrl(this.Settings.editorUrl,this.Settings.editorVersion,e)+"#"+encodeURIComponent(JSON.stringify(e))}stripEditorVersion(e){if(void 0!==(e=(e||"").trim())&&null!=e)if(e){for(;0==e.indexOf("/");)e=e.substring(1);for(;0<e.length&&"/"===e[e.length-1];)e=e.substring(0,e.length-1)}else e="";return e}sanitizeHost(e){return e?(e=e.trim()).endsWith("/")?e:e+"/":e||""}getClassicEditorUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var r=e.substring(n+1);if(r)try{var s=JSON.parse(decodeURIComponent(r));if(s)for(var o in s)s.hasOwnProperty(o)&&(i[o]=s[o])}catch(e){}e=e.substring(0,n)}return e.toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e+="printess-editor/embed.html"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getLoaderUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var r=e.substring(n+1);if(r)try{var s=JSON.parse(decodeURIComponent(r));if(s)for(var o in s)s.hasOwnProperty(o)&&(i[o]=s[o])}catch(e){}e=e.substring(0,n)}return(e=e.toLocaleLowerCase().endsWith("embed.html")?e.substring(0,e.length-"embed.html".length):e).toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e.toLowerCase().endsWith("printess-editor/")||(e+="printess-editor/"),e+="loader.js"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getPrintessComponent(){return document.querySelector("printess-component")||null}applyFormFieldMappings(t,i){var n=[];if(!i)for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,value:t[e]});if(t)for(var r in t)if(t.hasOwnProperty(r)){var s=t[r],o=void 0!==i[r]&&void 0!==i[r].formField?i[r].formField:r;let e=s;void 0!==i[r]&&void 0!==i[r].values&&void 0!==i[r].values[e]&&(e=i[r].values[s]),n.push({name:o,value:e})}return n}reverseFormFieldMapping(e,t,i){let n=e||"",r=t||"";if(i)for(var s in i)if(i.hasOwnProperty(s)&&i[s].formField===e){if(i[n=s].values)for(var o in i[s].values)if(i[s].values.hasOwnProperty(o)&&i[s].values[o]===t){r=o;break}break}return{name:n,value:r}}setViewportMeta(){var i=document.getElementsByTagName("head");if(i&&0<i.length){let e=i[0].querySelector("meta[name=viewport]"),t=(e||((e=document.createElement("meta")).setAttribute("name","viewport"),i[0].appendChild(e)),e.getAttribute("content"));t?t.indexOf("interactive-widget")<0&&(t=t+(t?", ":"")+"interactive-widget=resizes-content",e.setAttribute("content",t)):e.setAttribute("content","interactive-widget=resizes-content")}}async initializeIFrame(t,e,i){let n=this,r=document.getElementById("printess"),s=e=>{t&&"function"==typeof t.onCloseTab&&t.onCloseTab(e)},o=e=>{switch(e.data.cmd){case"back":window.removeEventListener("message",o),window.removeEventListener("beforeunload",s),window.removeEventListener("unload",s),r.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onBack&&t.onBack();break;case"basket":window.removeEventListener("message",o),window.removeEventListener("beforeunload",s),window.removeEventListener("unload",s),r.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onAddToBasket&&t.onAddToBasket(e.data.token,e.data.thumbnailUrl);break;case"formFieldChanged":t&&"function"==typeof t.onFormFieldChanged&&t.onFormFieldChanged(e.data.n||e.data.name,e.data.v||e.data.value,e.data.ffCaption||"",e.data.l||e.data.label);break;case"priceChanged":t&&"function"==typeof t.onPriceChanged&&t.onPriceChanged(e.data.priceInfo);break;case"renderFirstPageImage":t&&"function"==typeof t.onRenderedFirstPageImage&&t.onRenderedFirstPageImage(e.data.result);break;case"save":t&&"function"==typeof t.onSave&&t.onSave(e.data.token)}};return new Promise(e=>{var t;r?("true"!==r.getAttribute("printessHasListener")&&(window.addEventListener("message",o),!0===i.showAlertOnTabClose&&(window.addEventListener("beforeunload",s),window.addEventListener("unload",s)),r.setAttribute("printessHasListener","true")),e(r)):((t=document.createElement("div")).setAttribute("id","printess-container"),t.setAttribute("style","display: none; position: absolute; top: 0; bottom: 0; right: 0; left: 0; width: 100%; height: 100%; z-index: 100000;"),(r=document.createElement("iframe")).setAttribute("src",this.ClassicEditorUrl),r.setAttribute("id","printess"),r.setAttribute("style","width:100%; heigth:100%;"),r.setAttribute("data-attached","false"),r.setAttribute("allow","xr-spatial-tracking; clipboard-read; clipboard-write;"),r.setAttribute("allowfullscreen","true"),r.classList.add("printess-owned"),t.appendChild(r),r.onload=()=>{e(r)},window.addEventListener("message",o),!0===i.showAlertOnTabClose&&(window.addEventListener("beforeunload",s),window.addEventListener("unload",s)),r.setAttribute("printessHasListener","true"),window.visualViewport&&window.visualViewport.addEventListener("scroll",()=>{r.contentWindow?.postMessage({cmd:"viewportScroll",height:window.visualViewport?.height,offsetTop:window.visualViewport?.offsetTop},"*")},{passive:!0}),n.setViewportMeta(),document.body.append(t))})}getPriceCategories(e){return{snippetPrices:e.snippetPrices.map(e=>e?e.label:null),priceCategories:{},price:e.formatMoney(e.getPriceForFormFields(e.getCurrentFormFieldValues())),productName:e.getProductName(),legalNotice:e.legalText,infoUrl:e.legalTextUrl}}onPriceChanged(i,n){try{let e=null;try{i.snippetPriceCategories&&0<i.snippetPriceCategories.length?n.stickers=i.snippetPriceCategories.filter(e=>n.snippetPrices&&n.snippetPrices.length>=e.priceCategory).map(e=>({productVariantId:n.snippetPrices[e.priceCategory-1].variantId,quantity:e.amount})):n.stickers=[],e=this.calculateCurrentPrices(i,n)}catch(e){console.error(e)}let t=document.getElementById("printess");t&&!n.hidePricesInEditor&&setTimeout(()=>{t.contentWindow.postMessage({cmd:"refreshPriceDisplay",priceDisplay:e},"*")},0);var r=this.getPrintessComponent();r&&r.editor&&r.editor.ui.refreshPriceDisplay(e)}catch(e){}}hideBcUiVersion(e,t){var i=this.getPrintessComponent();i&&i.editor&&i.editor.ui.hide(),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}async showBcUiVersion(t,s){let i=this;var e=t.getPriceInfo();let n=null,r=null;n=i.applyFormFieldMappings(t.getCurrentFormFieldValues(),t.getFormFieldMappings()),r=t.getMergeTemplates();var o=i.getLoaderUrl(this.Settings.editorUrl,this.Settings.editorVersion,{}),o=await import(o);let a=i.getPrintessComponent();a&&a.editor?(a.style.display="block",await a.editor.api.loadTemplateAndFormFields(t.templateNameOrSaveToken,r,n,null),a.editor.ui.show()):(e={domain:i.Settings.apiDomain,mergeTemplates:r,formFields:n,token:i.Settings.shopToken,templateName:t.templateNameOrSaveToken,translationKey:"",basketId:"function"==typeof t.getBasketId&&t.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof t.getUserId?t.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",snippetPriceCategoryLabels:e&&e.snippetPrices?e.snippetPrices:null,theme:i.Settings.uiSettings&&i.Settings.uiSettings.theme||"",addToBasketCallback:(e,t)=>{s&&"function"==typeof s.onAddToBasket&&s.onAddToBasket(e,t)},formFieldChangedCallback:(e,t,i,n,r)=>{s&&"function"==typeof s.onFormFieldChanged&&s.onFormFieldChanged(e,t,r,n)},priceChangeCallback:e=>{s&&"function"==typeof s.onPriceChanged&&s.onPriceChanged(e)},backButtonCallback:e=>{i.hideBcUiVersion(t,!0)},saveTemplateCallback:(e,t)=>{"function"==typeof s.onSave&&s.onSave(e)}},o=await o.load(e),(a=i.getPrintessComponent())&&(a.editor=o))}async show(r){let s=this,n=!1;r&&r.templateNameOrSaveToken&&(n=0===r.templateNameOrSaveToken.indexOf("st:")&&90===r.templateNameOrSaveToken.length);var o={onBack:()=>{s.hide(r,!0)},onAddToBasket:(e,t)=>{let i=r.onAddToBasket(e,t);i&&i.waitUntilClosingMS?setTimeout(function(){"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),s.hide(r,!1)},i.waitUntilClosingMS):(i&&"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),s.hide(r,!1))},onFormFieldChanged:(e,t,i,n)=>{e=s.reverseFormFieldMapping(e,t,r.getFormFieldMappings());"function"==typeof r.onFormFieldChanged&&r.onFormFieldChanged(e.name,e.value,i,n)},onPriceChanged:e=>{s.onPriceChanged(e,r)},onRenderedFirstPageImage:e=>{"function"==typeof r.onRenderFirstPageImage&&r.onRenderFirstPageImage(e)},onSave:e=>{"function"==typeof r.onSave&&r.onSave(e,"")},onCloseTab:e=>{e.preventDefault(),e.returnValue=""}};if(this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion)s.showBcUiVersion(r,o);else{var a=r.getPriceInfo();let e=null,t=null,i=(n||(e=this.applyFormFieldMappings(r.getCurrentFormFieldValues(),r.getFormFieldMappings()),t=r.getMergeTemplates()),await this.initializeIFrame(o,r,this.Settings));if("false"===i.getAttribute("data-attached"))try{var d={domain:s.Settings.apiDomain,token:this.Settings.shopToken||"",templateName:r.templateNameOrSaveToken,showBuyerSide:!0,templateUserId:"",basketId:"function"==typeof r.getBasketId&&r.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof r.getUserId?r.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",formFields:e,snippetPriceCategoryLabels:a&&a.snippetPrices?a.snippetPrices:null,mergeTemplates:t};if(null!=r.showSplitterGridSizeButton&&(d.showSplitterGridSizeButton=!0===r.showSplitterGridSizeButton||"true"===r.showSplitterGridSizeButton),this.Settings.uiSettings&&this.Settings.uiSettings.theme&&(d.theme=this.Settings.uiSettings.theme),this.Settings.attachParams)for(var l in this.Settings.attachParams)this.Settings.attachParams.hasOwnProperty(l)&&(d[l]=this.Settings.attachParams[l]);if(void 0!==r.additionalAttachParams||null!==r.additionalAttachParams)for(var p in r.additionalAttachParams)r.additionalAttachParams.hasOwnProperty(p)&&(d[p]=r.additionalAttachParams[p]);i.contentWindow.postMessage({cmd:"attach",properties:d},"*"),i.setAttribute("data-attached","true"),setTimeout(function(){i.contentWindow.focus()},0)}catch(e){console.error(e)}else{o={templateNameOrToken:r.templateNameOrSaveToken,mergeTemplates:t,formFields:e,snippetPriceCategoryLabels:a&&a.snippetPrices?a.snippetPrices:null,formFieldProperties:void 0,clearExchangeCaches:!0};this.Settings.attachParams&&(this.Settings.attachParams.formFieldProperties&&(o.formFieldProperties=this.Settings.attachParams.formFieldProperties),void 0!==this.Settings.attachParams.clearExchangeCaches)&&(o.clearExchangeCaches=!1!==this.Settings.attachParams.clearExchangeCaches),r&&r.additionalAttachParams&&(r.additionalAttachParams.formFieldProperties&&(o.formFieldProperties=r.additionalAttachParams.formFieldProperties),void 0!==r.additionalAttachParams.clearExchangeCaches)&&(o.clearExchangeCaches=!1!==r.additionalAttachParams.clearExchangeCaches),i.contentWindow.postMessage({cmd:"loadTemplateAndFormFields",parameters:[o.templateNameOrToken,o.mergeTemplates,o.formFields,o.snippetPriceCategoryLabels,o.formFieldProperties,o.clearExchangeCaches]},"*"),setTimeout(function(){i.contentWindow.focus()},0)}}document.body.classList.add("hideAll");a=document.getElementsByTagName("html"),a&&0<a.length&&a[0].classList.add("printess-editor-open"),o=document.getElementById("printess-container");o&&o.style.setProperty("display","block","important")}hide(e,t){this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion?(i=this.getPrintessComponent())&&i.editor&&i.editor.ui.hide():(i=document.getElementById("printess-container"))&&(i.style.display="none"),document.body.classList.remove("hideAll");var i=document.getElementsByTagName("html");i&&0<i.length&&i[0].classList.remove("printess-editor-open"),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}static getGlobalShopSettings(){return window&&window.printessGlobalConfig?window.printessGlobalConfig:{}}static getGlobalFormFields(){var e=PrintessEditor.getGlobalShopSettings();let t;if(null!=typeof e.formFields&&e.formFields)if("function"==typeof e.formFields)try{t=e.formFields()}catch(e){console.error(e)}else t=e.formFields;return t||{}}}function initPrintessEditor(e,t,i,n,r,s,o=""){let a;return a=e&&"string"!=typeof e?{apiDomain:e.apiDomain||null,shopToken:e.shopToken||"",editorUrl:e.editorUrl||"",editorVersion:e.editorVersion||"",attachParams:e.attachParams||"",showAlertOnTabClose:null!=e.showTabClosingAlert&&!0===e.showTabClosingAlert,uiSettings:{showStartupAnimation:null==e.showStartupAnimation||!0===e.showStartupAnimation,startupBackgroundColor:e.startupBackgroundColor||"#ffffff",theme:e.theme||"",startupLogoUrl:e.startupLogoUrl||"",uiVersion:e.uiVersion||""},...e}:{apiDomain:null,shopToken:e||"",editorUrl:t,editorVersion:i,uiSettings:{showStartupAnimation:r,startupBackgroundColor:o,startupLogoUrl:n,theme:s}},new PrintessEditor(a)};